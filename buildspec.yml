version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto11
    commands:
      - echo "Installing dependencies..."
      - cd app # Change directory to app
      - mvn install -DskipTests # Installing dependencies without tests
      - echo "Installing jq..."
      - yum install -y jq  # Installing jq to parse JSON responses

  build:
    commands:
      - echo "Building project..."
      - mvn -B package # Building the project

  post_build:
    commands:
      - echo "Build completed successfully!"
      - echo "Downloading Veracode API Wrapper Docker Image..."
      - docker pull veracode/api-wrapper-java:latest # Pulling the Veracode API wrapper Docker image
      - echo "Fetching Veracode API credentials from Secrets Manager..."
      - export VERACODE_API_ID=$(aws secretsmanager get-secret-value --secret-id VERACODE_API_ID_SECRET --query SecretString --output text | jq -r .VERACODE_API_ID)
      - export VERACODE_API_KEY=$(aws secretsmanager get-secret-value --secret-id VERACODE_API_KEY_SECRET --query SecretString --output text | jq -r .VERACODE_API_KEY)
      - echo "Running Veracode Static Analysis..."
      - docker run --rm \
          -e VERACODE_API_ID=$VERACODE_API_ID \
          -e VERACODE_API_KEY=$VERACODE_API_KEY \
          -v $(pwd):/data \
          veracode/api-wrapper-java:latest \
          -action uploadandscan \
          -vid $VERACODE_API_ID \
          -vkey $VERACODE_API_KEY \
          -appname verademo-java \
          -createprofile true \
          -version $(date +%Y-%m-%d-%H:%M) \
          -filepath /data/app/target/verademo.war \
          -sandboxname aws-codebuild \
          -createsandbox false

artifacts:
  files:
    - app/target/*.war # Ensure that the WAR file is available for the scan
